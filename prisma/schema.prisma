generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Project {
  id                String                  @id @default(cuid())
  title             String
  startDate         DateTime
  endDate           DateTime?
  userId            String
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  timeScale         TimeScale               @default(DAY)
  assigneeColors    AssigneeColor[]
  assigneeOptions   ProjectAssigneeOption[]
  task_dependencies task_dependencies[]
  tasks             Task[]

  @@map("projects")
}

model Task {
  id                                                       String              @id @default(cuid())
  title                                                    String
  assignee                                                 String
  plannedStart                                             DateTime?
  plannedEnd                                               DateTime?
  /// 完了状態（UIはチェックボックスで制御）
  isCompleted                                              Boolean             @default(false)
  /// 旧仕様（完了日）。互換/移行用に残すが、UIでは非表示
  completedAt                                              DateTime?
  order                                                    Int                 @default(0)
  deleted                                                  Boolean             @default(false)
  projectId                                                String
  parentId                                                 String?
  createdAt                                                DateTime            @default(now())
  updatedAt                                                DateTime            @updatedAt
  task_dependencies_task_dependencies_predecessorIdTotasks task_dependencies[] @relation("task_dependencies_predecessorIdTotasks")
  task_dependencies_task_dependencies_successorIdTotasks   task_dependencies[] @relation("task_dependencies_successorIdTotasks")
  project                                                  Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent                                                   Task?               @relation("TaskHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  subTasks                                                 Task[]              @relation("TaskHierarchy")

  @@map("tasks")
}

model AssigneeColor {
  id         String   @id @default(cuid())
  assignee   String
  colorIndex Int
  projectId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, assignee])
  @@map("assignee_colors")
}

model ProjectAssigneeOption {
  id        String   @id @default(cuid())
  name      String
  order     Int
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, order])
  @@unique([projectId, name])
  @@map("project_assignee_options")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model task_dependencies {
  id                                           String         @id
  projectId                                    String
  predecessorId                                String
  successorId                                  String
  type                                         DependencyType @default(FS)
  createdAt                                    DateTime       @default(now())
  updatedAt                                    DateTime
  tasks_task_dependencies_predecessorIdTotasks Task           @relation("task_dependencies_predecessorIdTotasks", fields: [predecessorId], references: [id], onDelete: Cascade)
  projects                                     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks_task_dependencies_successorIdTotasks   Task           @relation("task_dependencies_successorIdTotasks", fields: [successorId], references: [id], onDelete: Cascade)

  @@unique([projectId, predecessorId, successorId])
  @@index([projectId])
}

enum DependencyType {
  FS
}

enum TimeScale {
  DAY
  WEEK
}

/// Stripeの課金状態（ClerkのuserIdで紐付け）
model UserSubscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  /// ワンタイム購入（永久）用
  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(FREE)
  currentPeriodEnd     DateTime?
  purchasedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@map("user_subscriptions")
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
  UNPAID
}
